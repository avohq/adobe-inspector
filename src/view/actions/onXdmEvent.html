<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure XDM Extraction</title>
    <script src="https://assets.adobedtm.com/activation/reactor/extensionbridge/extensionbridge.min.js"></script>
    <style>
        /* Avo-inspired Design */
        :root {
            --avo-primary: #FF0077;
            --avo-light-gray: #E5E7EB;
            --avo-dark-text: #1F2937;
            --avo-input-border: #D1D5DB;
            --avo-input-focus: var(--avo-primary);
            --avo-error: #DC2626;
            --avo-success: #059669;
            --avo-bg: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--avo-bg);
            color: var(--avo-dark-text);
            padding: 20px;
            max-width: 520px;
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .intro-text {
            font-size: 14px;
            color: #4B5563;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .intro-text strong {
            font-weight: 600;
            color: var(--avo-dark-text);
        }

        .config-container {
            background: #FAFAFA;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--avo-light-gray);
            margin-bottom: 16px;
        }

        .tenant-section {
            margin-bottom: 20px;
        }

        .tenant-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
        }

        .tenant-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--avo-dark-text);
            border: 1px solid var(--avo-error);
            border-radius: 6px;
            background: #ffffff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box;
        }

        .tenant-input.valid {
            border-color: var(--avo-input-border);
        }

        .tenant-input:focus {
            border-color: var(--avo-input-focus);
            box-shadow: 0 0 0 3px rgba(255, 0, 119, 0.2);
            outline: none;
        }

        .tenant-help {
            font-size: 12px;
            color: #6B7280;
            margin-top: 4px;
        }

        .field-section {
            margin-top: 20px;
        }

        .section-label {
            font-size: 14px;
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }

        .field-list {
            margin-bottom: 12px;
        }

        .field-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .field-input {
            flex: 1;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--avo-dark-text);
            border: 1px solid var(--avo-input-border);
            border-radius: 6px;
            background: #ffffff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .field-input:focus {
            border-color: var(--avo-input-focus);
            box-shadow: 0 0 0 3px rgba(255, 0, 119, 0.2);
            outline: none;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #9CA3AF;
            font-size: 16px;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 4px;
        }

        .remove-btn:hover {
            color: var(--avo-primary);
        }

        .add-button {
            border: none;
            background: none;
            font-size: 20px;
            color: var(--avo-primary);
            cursor: pointer;
            transition: color 0.2s ease;
            display: block;
            text-align: center;
            margin-top: 8px;
            padding: 4px;
        }

        .add-button:disabled {
            color: #bbb;
            cursor: default;
        }

        .add-button:hover:not(:disabled) {
            color: #D60062;
        }

        .validation-message {
            font-size: 12px;
            margin-top: 4px;
            padding: 6px 8px;
            border-radius: 4px;
        }

        .validation-error {
            background: #FEF2F2;
            color: var(--avo-error);
            border: 1px solid #FECACA;
        }

        .validation-success {
            background: #F0FDF4;
            color: var(--avo-success);
            border: 1px solid #BBF7D0;
        }

        .examples {
            background: #F8FAFC;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid var(--avo-primary);
            margin-top: 12px;
        }

        .examples h4 {
            font-size: 13px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--avo-dark-text);
        }

        .examples code {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            color: #374151;
            background: #ffffff;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #E5E7EB;
        }

        .examples ul {
            margin: 0;
            padding-left: 16px;
        }

        .examples li {
            font-size: 12px;
            color: #4B5563;
            margin-bottom: 4px;
        }
    </style>
</head>

<body>
    <h2>Configure XDM Data Extraction</h2>

    <p class="intro-text">
        Configure how <strong>XDM (Experience Data Model)</strong> events are processed and sent to
        <strong>Avo Inspector</strong>. You'll need to specify your tenant ID and select which
        top-level XDM fields should be extracted for schema validation.
    </p>

    <div class="config-container">
        <div class="tenant-section">
            <label class="tenant-label" for="tenantId">Tenant ID (Required)</label>
            <input id="tenantId" class="tenant-input" type="text" placeholder="e.g., _yourcompany">
            <div class="tenant-help">
                Your Adobe tenant ID, typically starts with an underscore (e.g., _yourcompany)
            </div>
            <div id="tenantValidation" class="validation-message" style="display: none;"></div>
        </div>

        <div class="tenant-section">
            <label class="tenant-label" for="tenantPath">Tenant Path (Optional)</label>
            <input id="tenantPath" class="tenant-input" type="text" placeholder="e.g., detail.xdm._tenantId">
            <div class="tenant-help">
                Optional path to your tenant object. If not provided, the extension will look for the tenant ID at the
                top level.
                Examples: 'detail.xdm._tenantId' or 'detail.data._tenantId'
            </div>
        </div>

        <div class="examples">
            <h4>What is a Tenant ID?</h4>
            <ul>
                <li>Your unique Adobe tenant identifier for custom XDM properties</li>
                <li>Found in your XDM data structure as a top-level object key</li>
                <li>Example: If your XDM has <code>"_yourcompany": {...}</code>, then <code>_yourcompany</code> is your
                    tenant ID</li>
            </ul>

            <h4>ðŸŽ¯ Important: Automatic Property Extraction</h4>
            <ul>
                <li><strong>All properties inside your tenant object are automatically extracted</strong></li>
                <li>They are promoted to the top-level of your Inspector event</li>
                <li>You don't need to specify tenant properties in the "XDM Fields" list below</li>
                <li>Example: <code>{"_yourcompany": {"customProp": "value"}}</code> becomes
                    <code>{"customProp": "value"}</code>
                </li>
            </ul>
        </div>
    </div>

    <div class="config-container">
        <div class="field-section">
            <label class="section-label">XDM Fields to Extract</label>
            <p class="intro-text">
                Select the <strong>top-level XDM fields</strong> that should be included in your Inspector events.
                Common fields are pre-populated, but you can add, remove, or modify them as needed.
                <br><br>
                <strong>Note:</strong> These are for standard XDM schema fields only. Your custom tenant properties
                (configured above) are automatically included and don't need to be listed here.
            </p>

            <div id="fieldList" class="field-list"></div>
            <button id="addFieldButton" class="add-button" onclick="addNewField()">+ Add Field</button>
        </div>

        <div class="examples">
            <h4>Common XDM Fields:</h4>
            <ul>
                <li><code>device</code> - Device information (screen size, type, etc.)</li>
                <li><code>environment</code> - Browser and environment details</li>
                <li><code>web</code> - Web-specific data (page details, referrer, etc.)</li>
                <li><code>placeContext</code> - Geographic and location data</li>
                <li><code>timestamp</code> - Event timestamp</li>
                <li><code>implementationDetails</code> - SDK implementation info</li>
            </ul>
        </div>
    </div>

    <script>
        let currentXdmFields = [];
        let tenantId = "";
        let tenantPath = "";

        const DEFAULT_XDM_FIELDS = [
            "device",
            "environment",
            "implementationDetails",
            "placeContext",
            "timestamp",
            "web"
        ];

        function generateFieldList(settings) {
            // Initialize tenant ID
            const savedTenantId = settings?.settings?.tenantId || "";
            document.getElementById("tenantId").value = savedTenantId;
            validateTenantId(savedTenantId);

            // Initialize tenant path
            const savedTenantPath = settings?.settings?.tenantPath || "";
            document.getElementById("tenantPath").value = savedTenantPath;

            // Initialize XDM fields
            currentXdmFields = settings?.settings?.xdmFields?.length
                ? settings.settings.xdmFields
                : [...DEFAULT_XDM_FIELDS];

            const fieldListDiv = document.getElementById("fieldList");
            fieldListDiv.innerHTML = "";

            currentXdmFields.forEach(field => addFieldToUI(field));
            updateAddButtonState();
        }

        function addFieldToUI(field) {
            const fieldListDiv = document.getElementById("fieldList");
            const fieldItem = document.createElement("div");
            fieldItem.classList.add("field-item");

            const fieldInput = document.createElement("input");
            fieldInput.type = "text";
            fieldInput.classList.add("field-input");
            fieldInput.value = field;
            fieldInput.placeholder = "Enter XDM field name";
            fieldInput.addEventListener("input", () => {
                updateFieldsFromUI();
                updateAddButtonState();
            });

            const removeBtn = document.createElement("button");
            removeBtn.innerHTML = "âœ–";
            removeBtn.classList.add("remove-btn");
            removeBtn.title = "Remove field";
            removeBtn.onclick = () => {
                fieldItem.remove();
                updateFieldsFromUI();
                updateAddButtonState();
            };

            fieldItem.appendChild(fieldInput);
            fieldItem.appendChild(removeBtn);
            fieldListDiv.appendChild(fieldItem);

            // Focus on new empty fields
            if (!field) {
                fieldInput.focus();
            }
        }

        function addNewField() {
            addFieldToUI("");
            updateFieldsFromUI();
            updateAddButtonState();
        }

        function updateFieldsFromUI() {
            currentXdmFields = Array.from(document.querySelectorAll(".field-input"))
                .map(input => input.value.trim())
                .filter(Boolean);
        }

        function updateAddButtonState() {
            const hasEmptyField = Array.from(document.querySelectorAll(".field-input"))
                .some(input => input.value.trim() === "");
            document.getElementById("addFieldButton").disabled = hasEmptyField;
        }

        function validateTenantId(value) {
            const tenantInput = document.getElementById("tenantId");
            const validationDiv = document.getElementById("tenantValidation");

            if (!value || value.trim() === "") {
                tenantInput.classList.remove("valid");
                validationDiv.className = "validation-message validation-error";
                validationDiv.textContent = "Tenant ID is required";
                validationDiv.style.display = "block";
                return false;
            } else if (!value.startsWith("_")) {
                tenantInput.classList.remove("valid");
                validationDiv.className = "validation-message validation-error";
                validationDiv.textContent = "Tenant ID should typically start with an underscore";
                validationDiv.style.display = "block";
                return false;
            } else {
                tenantInput.classList.add("valid");
                validationDiv.className = "validation-message validation-success";
                validationDiv.textContent = "Valid tenant ID format";
                validationDiv.style.display = "block";
                return true;
            }
        }

        // Event listeners
        document.getElementById("tenantId").addEventListener("input", (e) => {
            tenantId = e.target.value.trim();
            validateTenantId(tenantId);
        });

        document.getElementById("tenantPath").addEventListener("input", (e) => {
            tenantPath = e.target.value.trim();
        });

        window.extensionBridge.register({
            init: function (settings) {
                generateFieldList(settings);
            },
            getSettings: function () {
                updateFieldsFromUI();
                return {
                    tenantId: document.getElementById("tenantId").value.trim(),
                    tenantPath: document.getElementById("tenantPath").value.trim(),
                    xdmFields: currentXdmFields
                };
            },
            validate: function () {
                const tenantIdValue = document.getElementById("tenantId").value.trim();
                const isValidTenant = validateTenantId(tenantIdValue);
                const hasFields = currentXdmFields.length > 0;

                return isValidTenant && hasFields;
            }
        });
    </script>
</body>

</html>
